<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Halva Potten – aktuella vinstsummor (SHL)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;max-width:900px}
  h1{margin:0 0 4px}
  .meta{color:#555;margin-bottom:10px}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  button,select{padding:.45rem .7rem;font-size:.95rem}
  table{width:100%;border-collapse:collapse}
  th,td{padding:.6rem .7rem;border-bottom:1px solid #e6e6e6}
  th{text-align:left;background:#fafafa;font-weight:600}
  tr:hover td{background:#fcfcfc}
  .amt{font-variant-numeric:tabular-nums;text-align:right}
  .club a{text-decoration:none;color:inherit}
  .lulea{font-weight:800}
  .status{margin-left:auto;color:#555}
  .indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:middle}
  .ok{background:#0a0}
  .warn{background:#e6b800}
  .bad{background:#c00}
  .flash{animation:flash 600ms ease}
  @keyframes flash{from{background:#e7ffe7} to{background:transparent}}
  .legend{margin-top:12px;font-size:.9rem;color:#444}
  .legend span{display:inline-flex;align-items:center;margin-right:12px}
</style>
</head>
<body>
  <h1><span id="mainIndicator" class="indicator ok" title="Grönt = data uppdaterad senaste 10 minuterna"></span>Halva Potten – aktuella vinstsummor (SHL)</h1>
  <div class="meta">Senast laddad: <span id="loaded">–</span> | Senaste fetched_at: <span id="latest">–</span></div>
  <div class="controls">
    <button id="reload">Läs in data</button>
    <label>Auto-uppdatera:
      <select id="auto">
        <option value="0">Av</option>
        <option value="60">Var 1 min</option>
        <option value="300" selected>Var 5 min</option>
      </select>
    </label>
    <button id="copy">Kopiera som lista</button>
    <span class="status" id="status"></span>
  </div>

  <table id="tbl">
    <thead><tr><th>Klubb</th><th class="amt">Aktuell vinstsumma</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="legend">
    <strong>Färgförklaring:</strong>
    <span><span class="indicator ok" title="Data uppdaterad i senaste körningen"></span>Aktuell data</span>
    <span><span class="indicator warn" title="Oförändrad data från tidigare körning"></span>Oförändrad data</span>
    <span><span class="indicator bad" title="Data saknas eller har misslyckats flera gånger"></span>Fel eller saknas</span>
  </div>

<script>
const LULEA = 'Luleå HF';
let lastJson = '';
let previousData = {};

function fmt(n){ return n==null ? '—' : new Intl.NumberFormat('sv-SE').format(n)+' kr'; }
function set(id,v){ document.getElementById(id).textContent = v; }

async function fetchJson(){
  const res = await fetch('./data.json?_=' + Date.now(), { cache: 'no-store' });
  if (!res.ok) throw new Error('Kunde inte läsa data.json ('+res.status+')');
  set('loaded', new Date().toLocaleTimeString('sv-SE'));
  return res.json();
}

function statusClass(ageMinutes){
  if (ageMinutes <= 10) return 'ok';
  if (ageMinutes <= 30) return 'warn';
  return 'bad';
}

function updateMainIndicator(latestTime){
  const now = Date.now();
  const diffMin = (now - latestTime)/60000;
  const el = document.getElementById('mainIndicator');
  const cls = statusClass(diffMin);
  el.className = 'indicator ' + cls;
  if (cls==='ok') el.title='Grönt = data uppdaterad senaste 10 minuterna';
  else if (cls==='warn') el.title='Orange = data äldre än 10 min men yngre än 30 min';
  else el.title='Rött = data äldre än 30 min';
}

function render(data){
  // Sortering: Luleå HF först, därefter efter högsta vinstsumma
  const arr = (data || []).slice().sort((a,b)=>{
    if (a.club===LULEA) return -1;
    if (b.club===LULEA) return 1;
    const aAmt = a.amount ?? 0;
    const bAmt = b.amount ?? 0;
    return bAmt - aAmt; // högsta först
  });

  const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
  let newest = 0;
  const newPrev = {};

  for (const row of arr){
    const ts = Date.parse(row.fetched_at||'');
    if (!isNaN(ts)) newest = Math.max(newest, ts);
    const diffMin = (Date.now() - ts)/60000;
    const clubPrev = previousData[row.club];
    let color = 'ok';
    let tooltip = 'Aktuell data';

    if (row.amount==null){ color='bad'; tooltip='Fel eller saknas'; }
    else if (clubPrev && clubPrev.amount === row.amount){ color='warn'; tooltip='Oförändrad data'; }
    else if (clubPrev && clubPrev.errorCount >= 2){ color='bad'; tooltip='Upprepade fel'; }
    else { color = statusClass(diffMin); tooltip = 'Aktuell data'; }

    newPrev[row.club] = { amount: row.amount, errorCount: row.error ? (clubPrev?.errorCount||0)+1 : 0 };

    const tr = document.createElement('tr');
    const tdC = d


